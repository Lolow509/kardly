<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion – Kardly</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 items-center justify-center min-h-screen">
  
  <header class="bg-white shadow-md p-4 flex justify-between items-center" onclick="cancel_forgot()">
    <nav class="flex space-x-4">
      <img src="https://cdn-icons-png.flaticon.com/512/16994/16994123.png" width="25" height="25">
      <h1 class="text-xl font-bold text-gray-800">Kardly</h1>
    </nav>
  </header>
  

  <main class="p-4 space-y-6 max-w-xl mx-auto" style=" width: 400px;">
  <div class="bg-white p-8 rounded shadow-md w-full max-w-md" id="connexion_box">
    <h2 class="text-2xl font-bold mb-6 text-center" >Connexion à Kardly</h2>

    <div style="margin-bottom: 20px; text-align: center;">
      <img style="display: block; margin: auto;" src="https://cdn-icons-png.flaticon.com/512/16994/16994123.png " width="150" height="150">
    </div>

    
    <form id="loginForm" class="space-y-4">
      <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded" required>
      
      <div class="relative">
        <input type="password" name="mdp" id="mdpCo" placeholder="Mot de passe"  class="w-full px-4 py-2 pr-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
           <!-- Icône œil -->
        <button type="button" onclick="togglePassword('mdpCo')" class="absolute inset-y-0 right-2 flex items-center text-gray-600">
          <span> <img id="eye-icon" width="20" src="https://cdn-icons-png.flaticon.com/512/2115/2115194.png" alt=""> </span> 
        </button>
      </div>
      
      <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">
        Se connecter
      </button>
    </form>
    <div class="text-sm mt-4 text-center">
      <a onclick="document.getElementById('forgot_box').classList.remove('hidden'); document.getElementById('connexion_box').classList.add('hidden')" class="text-blue-500 hover:underline">Mot de passe oublié ?</a><br>
      <a onclick="document.getElementById('inscription_box').classList.remove('hidden'); document.getElementById('connexion_box').classList.add('hidden')" class="text-gray-500 hover:underline">Créer un compte</a>
    </div>
  </div>

  


    <div class="bg-white p-8 rounded shadow-md w-full max-w-md hidden" id="inscription_box">
      <h2 class="text-2xl font-bold mb-6 text-center">Inscription à Kardly</h2>

         <div style="margin-bottom: 20px; text-align: center;">
          <img style="display: block; margin: auto;" src="https://cdn-icons-png.flaticon.com/512/16994/16994123.png " width="150" height="150">
        </div>
      
      <form id="signUpForm" class="space-y-4">
        <input type="text" name="nom" placeholder="Nom" class="w-full p-3 border rounded" required>
        <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded" required>
        <input type="password" name="mdp" placeholder="Mot de passe" class="w-full p-3 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">
          S'inscrire
        </button>
      </form>
      <div class="text-sm mt-4 text-center">
        <a onclick="document.getElementById('inscription_box').classList.add('hidden'); document.getElementById('connexion_box').classList.remove('hidden')" class="text-gray-500 hover:underline">J'ai déjà un compte</a>
      </div>
    </div>



<!-- Mot de passe oublié -->
   <div class="bg-white p-8 rounded shadow-md w-full max-w-md hidden" id="forgot_box">
      <h2 class="text-2xl font-bold text-center" >Mot de passe oublié</h2>
       <p class="mb-6 text-center" >Tout au long du processus ne fermez pas cette page</p>


      <div>
        <label for="email_forgot" class="block text-sm font-medium text-gray-700" style="margin: 15px 0px; font-weight: bold;">Email</label>
        <input type="email" id="email_forgot" placeholder="Email" class="w-full p-3 border rounded" required>
        <button onclick="send_forgot()" class="w-full bg-gray-600 text-white p-3 rounded hover:bg-gray-700 transition" style="argin-bottom: 50px; margin-top: 20px;">
          Envoyer le code
        </button>
      </div>


     <div id="code_box" class="hidden">
      <label for="code_forgot" class="block text-sm font-medium text-gray-700" style="margin: 15px 0px; font-weight: bold;">Code</label>
       <label for="code_forgot" class="block text-sm font-medium text-gray-700" style="margin: 15px 0px; font-weight: bold;">Récupérer le code envoyer par email</label>
      <input type="text" onchange="code_forgot(this)" id="code_forgot" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>

      <div id="reset_box" class="hidden">
        <label for="reset_forgot" class="block text-sm font-medium text-gray-700" style="margin: 15px 0px; font-weight: bold;">Réinitialisation</label>

          <div style="gap:  20px; display: grid; grid-template-columns: 2fr 1fr;">
            <input type="password" id="reset_forgot" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required="">
            <button onclick="reset_forgot( document.getElementById('reset_forgot') )" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-red-700 transition">valide</button>
          </div>
        
     </div>


      <div class="text-sm mt-4 text-center" style="margin-top: 50px;">
        <button onclick="cancel_forgot()" class="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700 transition">Annuler</button>
      </div>
    </div>

  </main>

  


  <!-- Toast container -->
<div id="toast" class="fixed bottom-4 right-4 bg-white text-gray-800 px-4 py-3 rounded shadow-md border border-gray-200 hidden transition-opacity duration-300 z-50">
  <span id="toastMessage"></span>
</div>


  <!-- Wait Modal -->
<div id="modalWait" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center space-y-4">
    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="text-gray-700 font-medium">Veuillez patienter...</p>
  </div>
</div>

</body>

  <script src="services.js" type="text/javascript"> </script>
  <script>
    
    addEventListener("DOMContentLoaded", (event) => {
      infos = JSON.parse(localStorage.getItem("infos"))

      document.getElementById('modalWait').classList.remove('hidden')
       if(infos != null){
            window.location = "./dashboard.html"
         
          } else { 
             document.getElementById('modalWait').classList.add ('hidden')
           
           }

      
    })
     

    
//Connexion
document.getElementById('loginForm').addEventListener('submit', function (e) {
      document.getElementById('modalWait').classList.remove('hidden')
      
      e.preventDefault();
      var data = new FormData(e.target);
      var email = data.get('email');
      var mdp = data.get('mdp');
      mdp = window.btoa(mdp)

      if ( emailRegex.test(email) ) {
        call_login(email, mdp)
        
      } else {
        showToast("Votre adresse email n'est pas valide", "warning")
      }
      
      
})



//Connexion
function call_login(email, mdp){
       data = JSON.stringify({
                                email,
                                mdp,
                                action : "login_user"
                              })


  data_encode = encodeURIComponent(data)


  getUrl = `${url_api}?info=${data_encode}`

  fetch(getUrl, requestOptionsGet)
  .then((response) => response.json())
  .then((get_data) => {
    console.log(get_data)
        
        if(get_data.success == true){
          
          infos = get_data.message  
          localStorage.setItem("infos", JSON.stringify(infos) );
          
          window.location = "./dashboard.html" 
          
        } else {
          document.getElementById('modalWait').classList.add('hidden')
          showToast("Vous n'avez pas pu vous authentifier", "error")
        }
      
    })
      
}




//Inscription
document.getElementById('signUpForm').addEventListener('submit', function (e) {
      document.getElementById('modalWait').classList.remove('hidden')
      
      e.preventDefault();
      var data = new FormData(e.target);
      var nom = data.get('nom');
      var email = data.get('email');
      var mdp = data.get('mdp');
      


  

      if ( emailRegex.test(email) ) {

            if(mdp.length > 8){
                mdp = window.btoa(mdp)

              if(nom.trim().length > 2){
                call_signUp(nom, email, mdp)  
              }

              
              
            } else {
              showToast("Mot de passe trop court", "warning")
            }

        
        
      } else {
        showToast("Votre adresse email n'est pas valide", "warning")
      }
      
      
})



//inscription
function call_signUp(nom, email, mdp) {
  id = date.now()
       data = JSON.stringify({
                                id,
                                email,
                                mdp,
                                nom,
                                action : "login_user"
                              })


  data_encode = encodeURIComponent(data)


  getUrl = `${url_api}?info=${data_encode}`

  fetch(getUrl, requestOptionsGet)
  .then((response) => response.json())
  .then((get_data) => {
    console.log(get_data)

    
        if(get_data.success == true){

                      infos = {
                                email,
                                mdp,
                                nom,
                                id
                              }
    
          localStorage.setItem("infos", JSON.stringify(infos) );
    
          window.location = "./dashboard.html"

          
          
          
        } else {
          document.getElementById('modalWait').classList.add('hidden')
          showToast("Vous n'avez pas pu vous authentifier", "error")
        }

      
    })
      
}


function send_forgot(){
      email = document.getElementById('email_forgot').value
      code = genererCode(8)

      data = JSON.stringify({
                                email,
                                action : "reinit_mdp",
                                code
                              })


  data_encode = encodeURIComponent(data)


  getUrl = `${url_api}?info=${data_encode}`

  fetch(getUrl, requestOptionsGet)
  .then((response) => response.json())
  .then((get_data) => {
    console.log(get_data)
    
        if(get_data.success == true){
          localStorage.setItem("code_forgot", code );
          localStorage.setItem("uid_forgot", get_data.message.id );
          document.getElementById('code_forgot').classList.remove('hidden')
          document.getElementById('email_forgot').disabled = true
          
        }

    
    })

      
}




function code_forgot(e){

  code_init = e.value
  get_code = localStorage.getItem("code_forgot")

      if(code_init == get_code ){
        document.getElementById('code_forgot').disabled = true
        document.getElementById('reset_forgot').classList.remove('hidden')
        
      }
      
}



function reset_forgot(e){

  new_mdp = e.value
  uid = localStorage.getItem("uid_forgot");

      if(new_mdp.length > 8){

           data = JSON.stringify({
                                id : uid,
                                action : "update_user",
                                mdp: new_mdp
                              })

            
              data_encode = encodeURIComponent(data)
            
            
              getUrl = `${url_api}?info=${data_encode}`
            
              fetch(getUrl, requestOptionsGet)
              .then((response) => response.json())
              .then((get_data) => {
                console.log(get_data)
                
                    if(get_data.success == true){
                      cancel_forgot()
                      showToast("Votre mot de passe a été modifié avec succès", "success")
                      
                    }
            
                
                })
        
        
      }
  
}


    

function cancel_forgot(){
      localStorage.removeItem("code_forgot");
      localStorage.removeItem("uid_forgot");

      document.getElementById('email_forgot').disabled = false
      document.getElementById('code_forgot').classList.add('hidden')

      document.getElementById('code_forgot').disabled = false
      document.getElementById('reset_forgot').classList.add('hidden')
      
      
      document.getElementById('forgot_box').classList.add('hidden');
      document.getElementById('inscription_box').classList.add('hidden');
      document.getElementById('connexion_box').classList.remove('hidden')
        
    }

    
    
  </script>
</html>
